<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
"http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="Reply">
	<select id="replyNextVal" resultType="Integer">
		SELECT REPLY_IDX_SEQ.NEXTVAL FROM DUAL
	</select>

	<insert id="setReply">
		INSERT INTO REPLY
		(
			 REPLY_IDX
			,PA_IDX
			,REPLY_CONTENT
			,IN_ADMIN
			,IN_DATE	
		) 
		VALUES
		(
			 #{nextval}
			,#{pa_idx}
			,#{reply_content}
			,#{in_admin}
			,SYSDATE
		)
	</insert>
	
	<select id="getReplyList" resultType="HashMap">
		SELECT 
			A.* 
			,TO_CHAR(IN_DATE, 'YYYY-MM-DD HH24:MM') AS IN_DATE_STR
			,TO_CHAR(UP_DATE, 'YYYY-MM-DD HH24:MM') AS UP_DATE_STR
			,(SELECT COUNT(TYPE) FROM REPLY_AGREE WHERE REPLY_IDX = A.REPLY_IDX AND TYPE = 'Y') AS YES
      		,(SELECT COUNT(TYPE) FROM REPLY_AGREE WHERE REPLY_IDX = A.REPLY_IDX AND TYPE = 'N') AS NO
		FROM REPLY A
		WHERE PA_IDX = #{pa_idx} 
		ORDER BY REPLY_IDX DESC
	</select>
	
	<update id="modReply">
		 UPDATE REPLY SET
			 REPLY_CONTENT  = #{reply_content}
			,UP_ADMIN		= #{up_admin}
			,UP_DATE		= SYSDATE
		 WHERE REPLY_IDX	= #{reply_idx}
	</update>
	
	<delete id="delReply">
		DELETE FROM REPLY
		WHERE REPLY_IDX = #{reply_idx}
	</delete>
	
	<select id="agreeNextVal" resultType="Integer">
		SELECT REPLY_AGREE_IDX_SEQ.NEXTVAL FROM DUAL
	</select>
	
	<insert id="setAgree">
		INSERT INTO REPLY_AGREE
		(
			 IDX
			,REPLY_IDX
			,IN_ADMIN
			,IN_DATE	
			,TYPE
		) 
		VALUES
		(
			 #{nextval}
			,#{reply_idx}
			,#{in_admin}
			,SYSDATE
			,#{type}
		)
	</insert>
	
	<select id="chkAgree" resultType="Integer">
		SELECT 
	    	COUNT(*)
	    FROM REPLY_AGREE
	    WHERE REPLY_IDX = #{reply_idx}
	    AND IN_ADMIN = #{in_admin}
	</select>
</mapper>